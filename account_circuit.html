<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Account Circuit - Aztec Connect</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/css/style.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">Other</li><li class="chapter-item expanded "><a href="primitives.html"><strong aria-hidden="true">2.</strong> Primitives</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="schnorr.html"><strong aria-hidden="true">2.1.</strong> Schnorr Signatures</a></li><li class="chapter-item expanded "><a href="uint.html"><strong aria-hidden="true">2.2.</strong> Unsigned integers</a></li></ol></li><li class="chapter-item expanded "><a href="notes_and_nullifiers.html"><strong aria-hidden="true">3.</strong> Notes & Nullifiers</a></li><li class="chapter-item expanded "><a href="defi_bridge_interface.html"><strong aria-hidden="true">4.</strong> Defi Bridge Interface</a></li><li class="chapter-item expanded affix "><li class="part-title">'App' Circuits</li><li class="chapter-item expanded "><a href="account_circuit.html" class="active"><strong aria-hidden="true">5.</strong> Account Circuit</a></li><li class="chapter-item expanded "><a href="join_split_circuit.html"><strong aria-hidden="true">6.</strong> Join-Split Circuit</a></li><li class="chapter-item expanded "><a href="claim_circuit.html"><strong aria-hidden="true">7.</strong> Claim Circuit</a></li><li class="chapter-item expanded affix "><li class="part-title">Rollup Circuits</li><li class="chapter-item expanded "><a href="rollup_circuit.html"><strong aria-hidden="true">8.</strong> Rollup Circuit</a></li><li class="chapter-item expanded "><a href="root_rollup_circuit.html"><strong aria-hidden="true">9.</strong> Root Rollup Circuit</a></li><li class="chapter-item expanded "><a href="root_verifier_circuit.html"><strong aria-hidden="true">10.</strong> Root Verifier Circuit</a></li><li class="chapter-item expanded affix "><li class="part-title">Contracts</li><li class="chapter-item expanded "><a href="rollup_contract.html"><strong aria-hidden="true">11.</strong> Rollup Contract</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Aztec Connect</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="account-circuit"><a class="header" href="#account-circuit">Account Circuit</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>Aztec accounts are different from Ethereum addresses, mainly because deriving an Ethereum address is expensive (constraint-wise) within a circuit. Also, Aztec accounts have several extra features:</p>
<ul>
<li>A human-readable name (an <code>alias</code>) can be associated with an account public key.</li>
<li>Multiple (unlimited) spending keys (a.k.a. signing keys) can be associated with an <code>alias</code> and its <code>account_public_key</code>, to enable users to more-easily spend from multiple devices (for example).</li>
<li>Spending keys can also be used for account recovery (e.g. with the aid of a 3rd party).</li>
<li>If the account private key is compromised, a user can migrate to a new <code>account_public_key</code>. (They would also need to transfer all of their existing value notes to be owned by this new <code>account_public_key</code>).</li>
<li>If a spending private key is compromised, a user can also migrate to a new <code>account_public_key</code>, and a brand new set of spending keys can be associated with this new <code>account_public_key</code>. (They would also need to transfer all of their existing value notes to be owned by this new <code>account_public_key</code>).</li>
</ul>
<p>Keys:</p>
<ul>
<li>Spending/signing keys are used to <em>spend</em> value notes.</li>
<li>Account keys are used to decrypt encrypted value note data.
<ul>
<li>Also, initially (before any alias or signing keys are linked to the account), the 0th account key serves as a spending key for a user's value notes. Thereafter only spending keys can be used to spend notes.</li>
</ul>
</li>
</ul>
<p><em>See the diagram (below) for derivations of the various keys.</em></p>
<h2 id="keys"><a class="header" href="#keys">Keys</a></h2>
<table><thead><tr><th>Key Name</th><th>Derivation</th></tr></thead><tbody>
<tr><td><code>eth_private_key</code></td><td>Random 256 bits</td></tr>
<tr><td><code>eth_public_key</code></td><td><code>eth_private_key * secp256k1.generator</code></td></tr>
<tr><td><code>eth_address</code></td><td>The right-most 160-bits of <code>keccak256(eth_public_key)</code></td></tr>
<tr><td><code>account_private_key</code></td><td>The first 32-bytes of the signature:<br><code>eth_sign(&quot;\x19Ethereum Signed Message:\n&quot; + len(message) + message, eth_address)</code>*<br><br>where <code>message = &quot;Sign this message to generate your Aztec Privacy Key. This key lets the application decrypt your balance on Aztec.\n\nIMPORTANT: Only sign this message if you trust the application.&quot;</code><br><br>*using a client which has access to your <code>eth_address</code>'s private key, for signing.</td></tr>
<tr><td><code>account_public_key</code></td><td><code>account_private_key * grumpkin.generator</code></td></tr>
<tr><td><code>spending_private_key</code><br>a.k.a. <code>signing_private_key</code></td><td>Random 256 bits</td></tr>
<tr><td><code>spending_public_key</code><br>a.k.a. <code>signing_public_key</code></td><td><code>spending_private_key * grumpkin.generator</code></td></tr>
</tbody></table>
<h2 id="account-glossary"><a class="header" href="#account-glossary">Account Glossary</a></h2>
<table><thead><tr><th>Name</th><th>Definition</th><th>Description</th></tr></thead><tbody>
<tr><td>account</td><td></td><td>An account is generally used to mean an <code>(alias_hash, account_public_key)</code> pair.</td></tr>
<tr><td><code>alias</code></td><td>E.g. <code>alice</code></td><td>Some unique human-readable string.</td></tr>
<tr><td><code>alias_hash</code></td><td>The first 28-bytes of <code>blake2s_to_field(alias)</code>.<br>QUESTION: how does the output of blake2s get mapped to a field element?</td><td>A constant-sized representation of an <code>alias</code>, for use in circuits.</td></tr>
<tr><td><code>account_note</code></td><td><pre>{<br>  alias_hash,<br>  account_public_key<br>  spending_public_key<br>}</pre></td><td>Links together a user's <code>alias_hash</code>, their <code>account_public_key</code> and one of their <code>spending_public_key</code>s.<br><br>A user can register multiple account notes as a way of registering multiple <code>spending_public_keys</code> against their account. They might, for example, want to be able to spend from different devices without needing to share keys between them.<br><br>A user can also create a new account note as a way of registering a new <code>account_public_key</code> against their <code>alias_hash</code>. Ideally, a user would use just one <code>account_public_key</code> at a time (and transfer all value notes to be owned by that <code>account_public_key</code>), but this is not enforced by the protocol.</td></tr>
<tr><td><code>account_note.commitment</code></td><td><pre>pedersen::compress(<br>  alias_hash,<br>  account_public_key.x,<br>  spending_public_key.x<br>)</pre></td><td>Each account note commitment is stored in the data tree, so that our circuits can check whether spending and account keys have been correctly registered and actually belong to the user executing the transaction.</td></tr>
<tr><td><code>alias_hash_nullifier</code></td><td><pre>pedersen::compress(<br>  alias_hash<br>)</pre></td><td>This nullifier is added to the nullifier tree (by the rollup circuit) when executing the account circuit in <code>create</code> mode. It prevents an <code>alias</code> from ever being registered again by another user.</td></tr>
<tr><td><code>account_public_key_nullifier</code></td><td><pre>pedersen::compress(<br>  account_public_key.x,<br>  account_public_key.y<br>)</pre></td><td>This nullifier is added to the nullifier tree (by the rollup circuit) when executing the account circuit in <code>create</code> or <code>migrate</code> modes. It prevents an <code>account_public_key</code> from ever being registered again by another user.</td></tr>
</tbody></table>
<h2 id="modes-create-update-migrate"><a class="header" href="#modes-create-update-migrate">Modes: create, update, migrate</a></h2>
<p>The account circuit can be executed in one of three 'modes':</p>
<ul>
<li><strong>Create</strong>
<ul>
<li>Used to register a new <code>alias</code>.</li>
<li>A new 'account' is registered by generating nullifiers for a new <code>alias_hash</code> and a new <code>account_public_key</code>. This ensures the <code>alias_hash</code> and <code>account_public_key</code> haven't already been registered by someone else.</li>
<li>Two new <code>account_notes</code> may be created, as a way of registering the first two new <code>spending_public_keys</code> against the new account.</li>
<li>The circuit enforces that the caller knows the private key of <code>account_public_key</code>, by checking that a signature over the circuit's inputs has been signed by the <code>account_private_key</code>. We need to do this, in part, because the owner of this <code>account_public_key</code> might already have been sent value notes, even before registering it with Aztec Connect.</li>
<li>
<blockquote>
<p>Note: there are no protocol checks to ensure these new <code>spending_public_keys</code> (which are added to <code>account_notes</code>) are new or unique.</p>
</blockquote>
</li>
<li>
<blockquote>
<p>Note: There are no protocol checks during <code>create</code>, to ensure the user knows private keys to these <code>spending_public_keys</code>.</p>
</blockquote>
</li>
</ul>
</li>
<li><strong>Update</strong>
<ul>
<li>Used to add <em>additional</em> spending keys to an account.</li>
<li>Every account tx in <code>update</code> mode adds up-to two new spending keys to an account.</li>
<li>Two new <code>account_notes</code> are created, as a way of registering the two new <code>spending_public_keys</code> against the account.</li>
<li>No nullifiers are produced.</li>
<li>The circuit enforces that the caller knows the private key of an existing <code>signing_public_key</code> for this account, by:
<ul>
<li>checking that a signature over the circuit's inputs has been signed by a <code>signing_private_key</code>; and</li>
<li>checking that this <code>signing_public_key</code> is contained in an <code>account_note</code>'s commitment and that this commitment exists in the data tree.</li>
</ul>
</li>
<li>
<blockquote>
<p>Note: There are no protocol checks during <code>update</code>, to ensure the user knows private key to the <code>account_public_key</code>.</p>
</blockquote>
</li>
</ul>
</li>
<li><strong>Migrate</strong>
<ul>
<li>Used to update a user's <code>account_public_key</code> without changing their <code>alias</code>.</li>
<li>The new 'account' is registered by generating a nullifier for the new <code>account_public_key</code>.</li>
<li>Two new <code>account_notes</code> may be created, as a way of registering the first two new <code>spending_public_keys</code> against this new account.</li>
<li>The circuit enforces that the caller knows the private key of an existing <code>signing_public_key</code> for this account, by:
<ul>
<li>checking that a signature over the circuit's inputs has been signed by a <code>signing_private_key</code>; and</li>
<li>checking that this <code>signing_public_key</code> is contained in an <code>account_note</code>'s commitment and that this commitment exists in the data tree.</li>
</ul>
</li>
<li>
<blockquote>
<p>Note: There are no protocol checks during <code>migrate</code>, to ensure the user knows private key to the <code>account_public_key</code>.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="when-to-migrate"><a class="header" href="#when-to-migrate">When to migrate?</a></h3>
<p>If a user, Alice, suspects their <code>account_private_key</code> or <code>pending_private_key</code> have been compromised, then they should run the account circuit in <code>migrate</code> mode. As already stated, this will associate a new <code>account_public_key</code> to their <code>alias</code> and allow them to register new <code>spending_public_keys</code> against this new <code>account_public_key</code>. Two new account notes get created by the account circuit in <code>migrate</code> mode.</p>
<p>HOWEVER, the previous, 'old' account notes (containing the 'old' compromised key(s)), DO NOT get nullified. They are forever 'valid' notes in the data tree. Therefore, if Alice still owns <em>value</em> notes which are owned by one of her old <code>account_public_keys</code>, an attacker (who somehow knows the <em>private</em> key and a corresponding old <code>spending_private_key</code>) would still be able to spend such value notes. Therefore, after migrating their account, a user MUST ALSO transfer all of their existing notes to be owned by their new <code>account_public_key</code>.</p>
<h2 id="example-of-account-circuit-modes"><a class="header" href="#example-of-account-circuit-modes">Example of account circuit modes</a></h2>
<p>Each row of the table shows the data created by one execution of the account circuit. Rows are chronologically ordered.</p>
<table><thead><tr><th>Mode</th><th>alias</th><th>alias_hash</th><th>account public key</th><th>new spending keys</th><th>signer</th><th>new <code>alias_hash_</code><br><code>nullifier</code> emitted</th><th>new <code>account_</code><br><code>public_key_</code><br><code>nullifier</code> emitted</th><th>new account note commitments</th></tr></thead><tbody>
<tr><td>create</td><td><code>alice</code></td><td><code>h(alice)</code></td><td><code>apk_1</code></td><td><code>spk_1a, spk_1b</code></td><td><code>apk_1</code></td><td><code>h(h(alice))</code></td><td><code>h(apk_1.x, apk_1.y)</code></td><td><code>h(h(alice), apk_1, spk_1a)</code><br><br><code>h(h(alice), apk_1, spk_1b)</code></td></tr>
<tr><td>update</td><td><code>alice</code></td><td><code>h(alice)</code></td><td><code>apk_1</code></td><td><code>spk_1c, spk_1d</code></td><td><code>spk_1b</code> (e.g.)</td><td>-</td><td>-</td><td><code>h(h(alice), apk_1, spk_1c)</code><br><br><code>h(h(alice), apk_1, spk_1d)</code></td></tr>
<tr><td>update</td><td><code>alice</code></td><td><code>h(alice)</code></td><td><code>apk_1</code></td><td><code>spk_1e, spk_1f</code></td><td><code>spk_1a</code> (e.g.)</td><td>-</td><td>-</td><td><code>h(h(alice), apk_1, spk_1e)</code><br><br><code>h(h(alice), apk_1, spk_1f)</code></td></tr>
<tr><td>migrate</td><td><code>alice</code></td><td><code>h(alice)</code></td><td><code>apk_2</code></td><td><code>spk_2a, spk_2b</code></td><td><code>spk_1d</code> (e.g.)</td><td>-</td><td><code>h(apk_2.x, apk_2.y)</code></td><td><code>h(h(alice), apk_2, spk_2a)</code><br><br><code>h(h(alice), apk_2, spk_2b)</code></td></tr>
<tr><td>update</td><td><code>alice</code></td><td><code>h(alice)</code></td><td><code>apk_2</code></td><td><code>spk_2c, spk_2d</code></td><td><code>spk_2b</code> (e.g.)</td><td>-</td><td>-</td><td><code>h(h(alice), apk_2, spk_2c)</code><br><br><code>h(h(alice), apk_2, spk_2d)</code></td></tr>
</tbody></table>
<blockquote>
<p>Note: <code>h</code> is lazy notation, being used interchangeably in this table for different hashes. Consult the earlier tables or the below pseudocode for clarity on which hashes specifically are used.
Note: after an account <code>migrate</code>, all previous value notes should be transferred (via the join-split circuit) to be owned by the new account public key.</p>
</blockquote>
<h2 id="more-on-nullifiers"><a class="header" href="#more-on-nullifiers">More on Nullifiers</a></h2>
<p>Unlike the join-split circuit (for example), which always produces nullifiers, the account circuit only conditionally produces nullifiers (see the different modes above). It's possible for <code>nullifier_1</code> or <code>nullifier_2</code> to be <code>0</code>:</p>
<ul>
<li>
<p><code>nullifier_1 = create ? pedersen::compress(account_alias_hash) : 0;</code></p>
</li>
<li>
<p><code>nullifier_2 = (create || migrate) ? pedersen::compress(account_public_key) : 0</code></p>
</li>
</ul>
<blockquote>
<p>Note: The rollup circuit for Aztec Connect permits unlimited <code>0</code> nullifiers to be added to the nullifier tree, because:</p>
<ul>
<li>Each nullifier is added to the nullifier tree at the leafIndex which is equal to the nullifier value.</li>
<li>So the rollup circuit will try to add <code>nullifier = 0</code> to <code>leafIndex = 0</code>.</li>
<li>First it checks whether the leaf is empty. Well <code>0</code> implies &quot;empty&quot;, so this check will pass, and the value <code>0</code> will be once-again added to the 0th leaf.</li>
</ul>
</blockquote>
<h2 id="diagram"><a class="header" href="#diagram">Diagram</a></h2>
<p><a href="https://drive.google.com/file/d/1iscYm-B89I9LIB7YgM_L9cHaV6SSMjRT/view?usp=sharing">Here's</a> a detailed diagram of how all of Aztec's different keypairs are derived, and the flow of account creation and migration. (Edits are welcome - let Mike know if the link doesn't work).</p>
<h1 id="the-circuit"><a class="header" href="#the-circuit">The circuit</a></h1>
<h2 id="account-circuit-worked-example"><a class="header" href="#account-circuit-worked-example">Account Circuit: Worked Example</a></h2>
<p><em>There's a little diagram at the diagrams link too.</em></p>
<ol>
<li>Alice generates a grumpkin key pair <code>(account_private_key, account_public_key)</code>.</li>
<li>Alice can receive funds prior to registering an <code>alias</code> at <code>(account_public_key)</code>
<ul>
<li>I.e. a sender can send Alice funds by creating a value note with preimage values:
<ul>
<li><code>owner = account_public_key</code></li>
<li><code>requires_account = false</code></li>
</ul>
</li>
</ul>
</li>
<li>Alice can register the alias <code>alice</code> against her <code>account_public_key</code> using the account circuit.
<ul>
<li>The <code>alias_hash = hash('alice')</code> gets nullified, effectively 'reserving' the alias <code>alice</code> to prevent anyone else using it.</li>
<li>The <code>account_public_key</code> gets nullified, to prevent anyone else using it.</li>
<li>Alice's <code>new_account_public_key</code>, her <code>alias_hash</code>, and two new spending keys, are all linked together via two new account notes which get added to the data tree.</li>
</ul>
</li>
<li>Alice must then transfer any previously-received funds that were sent to <code>(account_public_key)</code> (i.e. value notes where <code>requires_account = false</code>), to value notes whose primage values contain <code>(account_public_key, requires_account = true)</code>.</li>
<li>Alice can register unlimited additional spending keys to <code>(alice, account_public_key)</code>, via additional calls to the account circuit (in <code>upgrade</code> mode).</li>
<li>If a <code>spending_public_key</code> becomes compromised, Alice must do the following:</li>
</ol>
<ul>
<li>generate a <em>new</em> account note with a <code>new_account_public_key</code> and her existing <code>alice</code> alias (using the <code>migrate</code> flow). The new account note's spending keys SHOULD be different to the compromised key (although there are no protocol checks to enforce this).</li>
<li>Use the account <code>update</code> flow to assign additional <em>non-comprimised</em> spending keys to her new account note`.</li>
<li>Alice transfers funds assigned to <code>(account_public_key, alice)</code> and sends them to <code>(new_account_public_key, alice)</code></li>
</ul>
<ol>
<li>Similarly, if Alice's <code>account_private_key</code> becomes compromised, she can use the account circuit to migrate to a new <code>account_public_key</code>.</li>
</ol>
<h2 id="circuit-inputs-summary"><a class="header" href="#circuit-inputs-summary">Circuit Inputs: Summary</a></h2>
<p>The inputs for the account circuit are:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">Account Inputs</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">Public Inputs</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">Private Inputs</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.174108em;vertical-align:-0.31em;"></span><span class="mord mathbb">F</span><span class="mord" style="margin-right:0.02778em;"><em></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.174108em;vertical-align:-0.31em;"></span><span class="mord mathbb">F</span><span class="mord" style="margin-right:0.02778em;"></em></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">25</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>As previously, the field <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.974998em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathbb">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> is from the BN254 specification.</p>
<h3 id="public-inputs-detail"><a class="header" href="#public-inputs-detail">Public Inputs: Detail</a></h3>
<p>Recall that all inner circuits must have the <strong>same number of public inputs</strong> as they will be used homogenously by the rollup circuit. Hence, most of the account circuit's public inputs are 0, because they're not actually needed for the account circuit's functionality.</p>
<ol>
<li><code>proof_id = PublicInputs::ACCOUNT</code> (i.e. this is effectively a witness which can only take one valid value).</li>
<li><code>output_note_commitment_1</code></li>
<li><code>output_note_commitment_2</code></li>
<li><code>nullifier_1</code></li>
<li><code>nullifier_2</code></li>
<li><code>public_value = 0</code></li>
<li><code>public_owner = 0</code></li>
<li><code>asset_id = 0</code></li>
<li><code>data_tree_root</code></li>
<li><code>tx_fee = 0</code></li>
<li><code>tx_fee_asset_id = 0</code></li>
<li><code>bridge_call_data = 0</code></li>
<li><code>defi_deposit_value = 0</code></li>
<li><code>defi_root = 0</code></li>
<li><code>backward_link = 0</code></li>
<li><code>allow_chain = 0</code></li>
</ol>
<h3 id="private-inputs-detail"><a class="header" href="#private-inputs-detail">Private Inputs: Detail</a></h3>
<ol>
<li><code>account_public_key</code></li>
<li><code>new_account_public_key</code></li>
<li><code>signing_public_key</code></li>
<li><code>signature</code></li>
<li><code>new_signing_public_key_1</code></li>
<li><code>new_signing_public_key_1</code></li>
<li><code>alias_hash = blake2s(alias).slice(0, 28)</code></li>
<li><code>account_nonce</code></li>
<li><code>create</code> (bool)</li>
<li><code>migrate</code> (bool)</li>
<li><code>account_note_index</code></li>
<li><code>account_note_path</code></li>
</ol>
<h2 id="circuit-logic-pseudocode"><a class="header" href="#circuit-logic-pseudocode">Circuit Logic (Pseudocode)</a></h2>
<p>Computed vars:</p>
<ul>
<li><code>signer</code> = <code>signing_public_key</code></li>
<li><code>message</code> = <code>pedersen::compress(alias_hash, account_public_key.x, new_account_public_key.x, spending_public_key_1.x, spending_public_key_2.x, nullifier_1, nullifier_2)</code></li>
<li><code>account_note_commitment</code> = <code>pedersen::compress(alias_hash, account_public_key.x, signer.x)</code></li>
</ul>
<p>Computed public inputs:</p>
<ul>
<li><code>output_note_commitment_1</code> = <code>pedersen::compress(alias_hash, new_account_public_key.x, spending_public_key_1.x)</code></li>
<li><code>output_note_commitment_2</code> = <code>pedersen::compress(alias_hash, new_account_public_key.x, spending_public_key_2.x)</code></li>
<li><code>nullifier_1</code> = <code>create ? pedersen::compress(alias_hash) : 0;</code></li>
<li><code>nullifier_2</code> = <code>create || migrate ? pedersen::compress(new_account_public_key)</code></li>
</ul>
<p>Circuit constraints:</p>
<ul>
<li><code>create == 1 || create == 0</code></li>
<li><code>migrate == 1 || migrate == 0</code></li>
<li><code>require(create &amp;&amp; migrate == 0)</code></li>
<li><code>require(new_account_public_key != spending_public_key_1)</code></li>
<li><code>require(new_account_public_key != spending_public_key_2)</code></li>
<li><code>if (migrate == 0) { require(account_public_key == new_account_public_key) }</code></li>
<li><code>verify_signature(message, signer, signature) == true</code></li>
<li><code>if (create == false) { require(membership_check(account_note_data, account_note_index, account_note_path, data_tree_root) == true) }</code></li>
<li>Assert all 'zeroed' public inputs are indeed zero.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="defi_bridge_interface.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="join_split_circuit.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="defi_bridge_interface.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="join_split_circuit.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="theme/sidebar.js"></script>
    </body>
</html>